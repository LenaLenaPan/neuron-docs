# Introduction and Usage of OPC UA

## Module Description

OPC UA is a machine-to-machine communication protocol for industrial automation developed by the OPC Foundation. OPC UA provides a standardized way for different devices and systems to communicate with each other regardless of the manufacturer or platform used.

The opc-ua module can be used to access OPCUA servers such as KEPServerEX, IGS, Prosys Simulation Server, Server_ctt, and also directly access some devices.

### Parameter Configuration

| Parameter        | Description                                                  |
| ---------------- | ------------------------------------------------------------ |
| **endpoint url** | The address of the remote access plc, the default value is `opc.tcp://127.0.0.1:4840/` |
| **username**     | The user used when connecting to plc                         |
| **password**     | The password used when connecting to plc                     |
| **cert**         | The certificate to provide login user authentication         |
| **key**          | The private key to provide signature and encrypted transmissions |

### Authentication Mode

* anonymos, requires OPCUA server to enable anonymous login;
* username-password, The OPCUA server needs to create a username with access permission. Neuron will automatically match the security Settings of OPCUA server and try to log in.
* cert-key + anonymos, which requires OPCUA server to enable appropriate security settings and set certificates, and **enable anonymous login**;
* cert-key + username-password, the OPCUA server must have created a username with access permission, and enable appropriate security Settings and set the certificate;

### Certificate Setting

OPCUA can login to OPC-UA server by user self-signed certificate, certificate and key must meet the following conditions.

* CERTIFICATE and KEYFILE must be set at the same time
* Certificate must be generated by X.509v3 standard
* The SAN field of the Certficate must contain `URI:urn:xxx.xxx.xxx`, with the "xxx" part being a custom part
* Certificate file and key file must be encoded with DER format

The certificate file can be imported into the target server in advance and set as trust, or it can be set by neuron and submitted automatically and then set as trust by the server.

Certificate generation steps(Windows/Linux/Mac):

```sh
$ openssl req -config localhost.cnf -new -nodes -x509 -sha256 -newkey rsa:2048 -keyout localhost.key -days 365 -subj "/C=DE/O=neuron/CN=NeuronClient@localhost" -out localhost.crt
$ openssl x509 -in localhost.crt -outform der -out client_cert.der
$ openssl rsa -inform PEM -in localhost.key -outform DER -out client_key.der
$ rm localhost.crt
$ rm localhost.key
```

`-days` can set the value as desired.

The *.cnf file specified by `-config` can be modified using the [template file for openssl](https://github.com/openssl/openssl/blob/master/apps/openssl.cnf) to be modified to include the following configuration section:

```sh
[ v3_req ]

# Extensions to add to a certificate request

basicConstraints = CA:FALSE
keyUsage = nonRepudiation, digitalSignature, keyEncipherment
subjectAltName = @alt_names

[ alt_names ]
URI.1 = urn:xxx.xxx.xxx
DNS.1 = localhost
#DNS.2 = localhost
IP.1 = 127.0.0.1
#IP.2 = 0.0.0.0
```

### Certificate Conversion

You can convert PEM certificate and private key to DER format by following steps and commands

Step 1: Save all the contents including `-----BEGIN CERTIFICATE-----` and `-----END CERTIFICATE-----` as 1.crt;</br>
Step 2: Save all the contents including `-----BEGIN PRIVATE KEY-----` and `-----END PRIVATE KEY-----` as 1.key;</br>
Step 3: Execute the following command:

```sh
$ openssl x509 -in 1.crt -outform der -out cert.der   
$ openssl rsa -inform PEM -in 1.key -outform DER -out key.der
```

### Support Data Type

* INT8 (OPCUA SBYTE type)
* INT16
* INT32
* INT64
* UINT8 (OPCUA BYTE type)
* UINT16
* UINT32 (also used to represent DATETIME types)
* UINT64
* FLOAT
* DOUBLE
* BOOL
* STRING

## Usage of Address Format

### Addresses Format

> IX!NODEID</span>

**IX** is the namespace index.

**NODEID** is the node id.

### Address Examples

| Address                | Data Type | Description                                                  |
| ---------------------- | --------- | ------------------------------------------------------------ |
| 0!2258                 | UINT32    | Get the timestamp of the OPCUA server using the NODEID of the numeric type.  NS is 0, and NODEID is 2258 |
| 2!Device1.Module1.Tag1 | INT8      | Get a data point of type SBYTE using a NODEID of type string. NS is 2, and NODEID is Device1.module1.tag1 |

::: tip
Please refer to OPC UA standard for the explanation of namespace index and node id.

The data type set by Neuron must match the OPCUA data type.
:::